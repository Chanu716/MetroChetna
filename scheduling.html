<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Scheduling Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            background: transparent;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-2px);
            border-color: #5c6bc0;
        }

        .status-card h3 {
            color: #1a237e;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }

        .status-icon {
            margin-right: 10px;
            font-size: 1.5em;
        }

        .train-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .train-item {
            background: rgba(248, 249, 250, 0.5);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #5c6bc0;
        }

        .train-item.ineligible {
            border-left-color: #e74c3c;
        }

        .train-item.cleaning {
            border-left-color: #f39c12;
        }

        .train-item.maintenance {
            border-left-color: #9b59b6;
        }

        .train-id {
            font-weight: 600;
            color: #1a237e;
        }

        .train-reason {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="page-header">
        <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê</button>
        <h1>Train Scheduling Dashboard</h1>
    </div>

    <button class="refresh-btn" onclick="loadSchedulingData()">üîÑ Refresh Data</button>
    <button class="refresh-btn" onclick="testAPIConnection()" style="background: #28a745;">üîç Test API Connection</button>

    <div id="loading" class="loading" style="display: none;">
        <p>Loading scheduling data...</p>
    </div>

    <div id="api-status" style="margin: 10px 0; padding: 10px; border-radius: 8px; display: none;"></div>

    <div id="summary-stats" class="summary-stats"></div>

    <div id="dashboard-content" class="dashboard-grid"></div>
</div>

<script src="railway-api.js"></script>
<script src="train-scheduler.js"></script>
<script>
    let scheduler;

    // Initialize scheduler when railway API is ready
    document.addEventListener('DOMContentLoaded', async function() {
        // Wait for railway API to initialize
        await new Promise(resolve => {
            const checkAPI = () => {
                if (window.railwayAPI || (typeof railwayAPI !== 'undefined' && railwayAPI.checkServerConnection)) {
                    const api = window.railwayAPI || railwayAPI;
                    scheduler = new TrainScheduler(api);
                    console.log('‚úÖ Scheduler initialized successfully');
                    resolve();
                } else {
                    console.log('‚è≥ Waiting for railway API...');
                    setTimeout(checkAPI, 100);
                }
            };
            checkAPI();
        });
        
        // Wait a bit more for server connection check
        setTimeout(() => {
            loadSchedulingData();
        }, 500);
    });

    async function loadSchedulingData() {
        const loadingDiv = document.getElementById('loading');
        const contentDiv = document.getElementById('dashboard-content');
        const statsDiv = document.getElementById('summary-stats');
        
        loadingDiv.style.display = 'block';
        contentDiv.innerHTML = '';
        statsDiv.innerHTML = '';

        try {
            if (!scheduler) {
                throw new Error('Scheduler not initialized');
            }

            // Generate comprehensive report
            const report = await scheduler.generateEligibilityReport();
            const priorityTrains = await scheduler.getHighPriorityBrandingTrains(5);

            // Display summary statistics
            displaySummaryStats(report);

            // Display detailed sections
            displayTrainSections(report, priorityTrains);

        } catch (error) {
            console.error('Error loading scheduling data:', error);
            contentDiv.innerHTML = `
                <div class="status-card">
                    <h3>‚ùå Error Loading Data</h3>
                    <p style="color: #e74c3c;">${error.message}</p>
                    <p>Make sure the server is running with: <code>npm start</code></p>
                    <button onclick="debugScheduler()" style="margin-top: 10px; padding: 8px 16px; background: #5c6bc0; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        üîç Debug Info
                    </button>
                </div>
            `;
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    // Debug function to check scheduler status
    async function debugScheduler() {
        console.log('=== SCHEDULER DEBUG INFO ===');
        console.log('Scheduler instance:', scheduler);
        console.log('Railway API available:', typeof railwayAPI !== 'undefined');
        console.log('Window Railway API:', window.railwayAPI);
        
        if (scheduler && scheduler.railwayAPI) {
            console.log('Server available:', scheduler.railwayAPI.isServerAvailable);
            
            try {
                console.log('Testing data fetch...');
                const testData = await scheduler.railwayAPI.getData('train_master');
                console.log('‚úÖ Test data fetch successful:', testData ? testData.length : 0, 'records');
            } catch (error) {
                console.error('‚ùå Test data fetch failed:', error);
            }
        }
        
        alert('Debug info logged to console (F12 > Console)');
    }

    // Test API connection function
    async function testAPIConnection() {
        const statusDiv = document.getElementById('api-status');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<p>üîÑ Testing API connection...</p>';
        
        try {
            console.log('Testing railway API...');
            
            if (typeof railwayAPI === 'undefined') {
                throw new Error('Railway API not loaded');
            }
            
            console.log('Railway API found, checking server...');
            statusDiv.innerHTML = '<p>üîÑ Checking server availability...</p>';
            
            // Force check server connection
            await railwayAPI.checkServerConnection();
            
            if (!railwayAPI.isServerAvailable) {
                throw new Error('Server connection failed');
            }
            
            statusDiv.innerHTML = '<p>üîÑ Testing data fetch...</p>';
            
            // Test fetching train master data
            const trainData = await railwayAPI.getData('train_master');
            console.log('‚úÖ Train data fetched:', trainData.length, 'records');
            
            // Test scheduler initialization
            if (!scheduler) {
                scheduler = new TrainScheduler(railwayAPI);
            }
            
            statusDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px;">
                    <h4>‚úÖ API Connection Successful!</h4>
                    <p>üöÇ Train Master: ${trainData.length} records</p>
                    <p>ü§ñ Scheduler: ${scheduler ? 'Initialized' : 'Failed'}</p>
                    <p>üåê Server: Connected</p>
                </div>
            `;
            
        } catch (error) {
            console.error('API Test Error:', error);
            statusDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px;">
                    <h4>‚ùå API Connection Failed</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Railway API:</strong> ${typeof railwayAPI !== 'undefined' ? 'Loaded' : 'Not loaded'}</p>
                    <p><strong>Server Available:</strong> ${railwayAPI ? railwayAPI.isServerAvailable : 'Unknown'}</p>
                    <p>Make sure the server is running with: <code>npm start</code></p>
                </div>
            `;
        }
    }

    function displaySummaryStats(report) {
        const statsDiv = document.getElementById('summary-stats');
        
        const stats = [
            { number: report.eligible_trains.length, label: 'Eligible Trains' },
            { number: report.ineligible_trains.length, label: 'Ineligible Trains' },
            { number: report.cleaning_required.length, label: 'Need Cleaning' },
            { number: report.maintenance_due.length, label: 'Maintenance Due' },
            { number: report.certificate_issues.length, label: 'Certificate Issues' }
        ];

        statsDiv.innerHTML = stats.map(stat => `
            <div class="stat-box">
                <div class="stat-number">${stat.number}</div>
                <div class="stat-label">${stat.label}</div>
            </div>
        `).join('');
    }

    function displayTrainSections(report, priorityTrains) {
        const contentDiv = document.getElementById('dashboard-content');
        
        const sections = [
            {
                title: '‚úÖ Eligible Trains',
                trains: report.eligible_trains,
                class: 'eligible'
            },
            {
                title: 'üßΩ Cleaning Required',
                trains: report.cleaning_required,
                class: 'cleaning'
            },
            {
                title: 'üîß Maintenance Due',
                trains: report.maintenance_due,
                class: 'maintenance'
            },
            {
                title: 'üìã Certificate Issues',
                trains: report.certificate_issues,
                class: 'ineligible'
            },
            {
                title: '‚≠ê High Priority Branding',
                trains: priorityTrains.map(t => ({
                    train_id: t.Train_ID,
                    reason: `Priority Score: ${t.priority_score.toFixed(2)} (${t.Remaining_Hours}h in ${t.days_until_end} days)`,
                    source: t.Source || '',
                    destination: t.Destination || ''
                })),
                class: 'priority'
            }
        ];

        contentDiv.innerHTML = sections.map(section => `
            <div class="status-card">
                <h3>
                    <span class="status-icon">${section.title.split(' ')[0]}</span>
                    ${section.title.substring(2)}
                    <span style="margin-left: auto; font-size: 0.8em; color: #6c757d;">
                        (${section.trains.length})
                    </span>
                </h3>
                <div class="train-list">
                    ${section.trains.length > 0 ? 
                        section.trains.map(train => `
                            <div class="train-item ${section.class}">
                                <div class="train-id">üöÇ ${train.train_id}</div>
                                ${train.source && train.destination ? 
                                    `<div style="font-size: 0.9em; color: #6c757d;">
                                        ${train.source} ‚Üí ${train.destination}
                                    </div>` : ''
                                }
                                <div class="train-reason">${train.reason}</div>
                                ${train.days_since_service !== undefined ? 
                                    `<div style="font-size: 0.8em; color: #6c757d;">
                                        Days since service: ${train.days_since_service}
                                    </div>` : ''
                                }
                            </div>
                        `).join('') : 
                        '<div style="text-align: center; color: #6c757d; padding: 20px;">No trains in this category</div>'
                    }
                </div>
            </div>
        `).join('');
    }
</script>

</body>
</html>