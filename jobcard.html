<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Card Management</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Dynamic Section Styles */
        .form-section {
            display: none;
            background-color: #262626;
            margin-top: 30px;
            padding: 30px 40px;
            border-radius: 4px;
            border: 2px solid #393939;
            animation: slideDown 0.3s ease-in-out;
        }
        
        .form-section.active {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        .close-section {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            padding: 5px;
            margin-right: 10px;
        }
        
        .close-section:hover {
            color: #f4f4f4;
        }
        
        /* Center single button */
        .button-container {
            text-align: center;
        }
        
        /* Enhanced textarea styling */
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #525252;
            background-color: #393939;
            color: #f4f4f4;
            border-radius: 0;
            box-sizing: border-box;
            font-size: 1em;
            font-family: 'IBM Plex Sans', sans-serif;
            min-height: 120px;
            resize: vertical;
        }
        
        textarea:focus {
            border-color: #0f62fe;
            outline: none;
        }
        
        textarea::placeholder {
            color: #8d8d8d;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }
        
        .action-card {
            background: #393939;
            padding: 40px 20px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #525252;
        }
        
        .action-card:hover {
            background: #525252;
            border-color: #0f62fe;
            transform: translateY(-2px);
        }
        
        .action-card h3 {
            margin-bottom: 15px;
            color: #f4f4f4;
            font-size: 1.3em;
        }
        
        .action-card p {
            color: #b0b0b0;
            margin: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Job Card Management</h1>
    
    <div class="action-buttons">
        <div class="action-card" onclick="showOpenNewCard()">
            <h3>Open New Card</h3>
        </div>
        
        <div class="action-card" onclick="showCloseExistingCard()">
            <h3>Close Existing Card</h3>
        </div>
    </div>

    <!-- Open New Card Section -->
    <div id="openCardSection" class="form-section">
        <div class="section-header">
            <span class="close-section" onclick="hideSection('openCardSection')">&times;</span>
        </div>
        <form id="openCardForm">
            <div class="form-group">
                <label for="newJobCardID">Job Card ID</label>
                <input type="text" id="newJobCardID" name="newJobCardID" readonly>
            </div>
            
            <div class="form-group">
                <label for="openDate">Open Date</label>
                <input type="date" id="openDate" name="openDate" readonly>
            </div>
            
            <div class="form-group">
                <label for="newTaskDescription">Task Description</label>
                <textarea id="newTaskDescription" name="newTaskDescription" required placeholder="Describe the maintenance work to be performed in detail..."></textarea>
            </div>
            
            <div class="button-container">
                <button type="submit" class="submit-btn">Open Job Card</button>
            </div>
        </form>
    </div>

    <!-- Close Existing Card Section -->
    <div id="closeCardSection" class="form-section">
        <div class="section-header">
            <span class="close-section" onclick="hideSection('closeCardSection')">&times;</span>
        </div>
        
        <form id="closeCardForm">
            <div class="form-group">
                <label for="existingJobCardID">Job Card ID</label>
                <select id="existingJobCardID" name="existingJobCardID" required>
                    <option value="" disabled selected>Select an open job card...</option>
                </select>
            </div>
            
            <div id="jobCardDetails" style="display: none;">
                <div class="form-group">
                    <label for="displayOpenDate">Opened Date</label>
                    <input type="text" id="displayOpenDate" name="displayOpenDate" readonly>
                </div>
                
                <div class="form-group">
                    <label for="displayTaskDescription">Job Description</label>
                    <textarea id="displayTaskDescription" name="displayTaskDescription" readonly></textarea>
                </div>
                
                <div class="button-container">
                    <button type="submit" class="submit-btn">Close Job Card</button>
                </div>
            </div>
        </form>
    </div>
</div>
</div>

<script>
    let openJobCards = []; // Will be loaded from Google Sheets
    let lastJobCardID = 3109; // Will be fetched from Google Sheets

    // Section functions
    function showSection(sectionId) {
        // Hide all sections first
        document.querySelectorAll('.form-section').forEach(section => {
            section.classList.remove('active');
        });
        // Show the selected section
        document.getElementById(sectionId).classList.add('active');
    }

    function hideSection(sectionId) {
        document.getElementById(sectionId).classList.remove('active');
        
        // Reset forms when hiding
        if (sectionId === 'openCardSection') {
            document.getElementById('openCardForm').reset();
        } else if (sectionId === 'closeCardSection') {
            document.getElementById('closeCardForm').reset();
            document.getElementById('jobCardDetails').style.display = 'none';
        }
    }

    async function showOpenNewCard() {
        try {
            // Get the latest job card ID from Google Sheets
            const existingCards = await railwayAPI.getJobCardData();
            if (existingCards && existingCards.length > 0) {
                const lastCard = existingCards[existingCards.length - 1];
                const lastIdNum = parseInt(lastCard.JobCard_ID.replace('JC', ''));
                lastJobCardID = lastIdNum;
            }

            // Set auto-incremented ID and today's date
            document.getElementById('newJobCardID').value = `JC${lastJobCardID + 1}`;
            document.getElementById('openDate').value = new Date().toISOString().split('T')[0];
            
            showSection('openCardSection');
            scrollToSection('openCardSection');
        } catch (error) {
            railwayAPI.showMessage(`Error loading job card data: ${error.message}`, 'error');
        }
    }

    async function showCloseExistingCard() {
        try {
            // Load open job cards from Google Sheets
            const jobCards = await railwayAPI.getJobCardData();
            openJobCards = jobCards.filter(card => card.Status === 'Open');
            
            // Populate dropdown with open job cards
            const select = document.getElementById('existingJobCardID');
            select.innerHTML = '<option value="" disabled selected>Select an open job card...</option>';
            
            openJobCards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.JobCard_ID;
                option.textContent = `${card.JobCard_ID} - ${card.Task_Description.substring(0, 50)}...`;
                select.appendChild(option);
            });
            
            showSection('closeCardSection');
            scrollToSection('closeCardSection');
        } catch (error) {
            railwayAPI.showMessage(`Error loading open job cards: ${error.message}`, 'error');
        }
    }

    // Handle job card selection for closing
    document.getElementById('existingJobCardID').addEventListener('change', function() {
        const selectedId = this.value;
        const selectedCard = openJobCards.find(card => card.JobCard_ID === selectedId);
        
        if (selectedCard) {
            document.getElementById('displayOpenDate').value = selectedCard.Opened_Date;
            document.getElementById('displayTaskDescription').value = selectedCard.Task_Description;
            document.getElementById('jobCardDetails').style.display = 'block';
        }
    });

    // Handle opening new job card
    document.getElementById('openCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const jobCardData = {
            JobCard_ID: document.getElementById('newJobCardID').value,
            Task_Description: document.getElementById('newTaskDescription').value,
            Opened_Date: document.getElementById('openDate').value,
            Status: 'Open',
            Closed_Date: ''
        };
        
        try {
            await railwayAPI.saveJobCardData(jobCardData);
            railwayAPI.showMessage('Job card opened successfully!');
            hideSection('openCardSection');
            
        } catch (error) {
            railwayAPI.showMessage(`Error opening job card: ${error.message}`, 'error');
        }
    });

    // Handle closing existing job card
    document.getElementById('closeCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const result = confirm('Are you sure you want to close this job card?');
        if (!result) return;
        
        const selectedId = document.getElementById('existingJobCardID').value;
        const selectedCard = openJobCards.find(card => card.JobCard_ID === selectedId);
        
        if (selectedCard) {
            const updatedJobCardData = {
                ...selectedCard,
                Status: 'Closed',
                Closed_Date: new Date().toISOString().split('T')[0]
            };
            
            try {
                await railwayAPI.updateJobCardData(selectedId, updatedJobCardData);
                railwayAPI.showMessage('Job card closed successfully!');
                hideSection('closeCardSection');
                
            } catch (error) {
                railwayAPI.showMessage(`Error closing job card: ${error.message}`, 'error');
            }
        }
    });

    // Scroll to section when opened
    function scrollToSection(sectionId) {
        setTimeout(() => {
            document.getElementById(sectionId).scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }, 100);
    }
</script>

<!-- Include the Railway API -->
<script src="railway-api.js"></script>

</body>
</html>