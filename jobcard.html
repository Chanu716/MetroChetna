<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open New Card</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Section Styles (always visible) */
        .form-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin-top: 30px;
            padding: 30px 40px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 16px rgba(92, 107, 192, 0.1);
            animation: slideDown 0.3s ease-in-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Center single button */
        .button-container {
            text-align: center;
        }
        
        /* Enhanced textarea styling */
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            background-color: #ffffff;
            color: #1a237e;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            font-family: 'IBM Plex Sans', sans-serif;
            min-height: 120px;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            border-color: #5c6bc0;
            outline: none;
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.1);
        }
        
        textarea::placeholder {
            color: #6c757d;
        }
        
        /* Remove action cards in this simplified page */
    </style>
</head>
<body>

<div class="global-header">
    <img src="https://vectorseek.com/wp-content/uploads/2023/09/Kerala-Government-Logo-Vector.svg-.png" alt="Kerala Government Emblem">
    <h2>Kochi Metro Rail Limited</h2>
    <img src="https://www.betterbuys.com/wp-content/uploads/2018/09/IBM.png" alt="IBM Logo">
</div>

<div class="container">
    <div class="page-header">
        <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê</button>
        <h1>Open New Job Card</h1>
    </div>

    <!-- Open New Card Section -->
    <div id="openCardSection" class="form-section">
        <form id="openCardForm">
            <div class="form-group">
                <label for="newJobCardID">Job Card ID</label>
                <input type="text" id="newJobCardID" name="newJobCardID" readonly>
            </div>
            
            <div class="form-group">
                <label for="newTrainID">Train ID</label>
                <input type="text" id="newTrainID" name="newTrainID" required placeholder="Enter Train ID (e.g., T001, T002...)">
            </div>
            
            <div class="form-group">
                <label for="openDate">Open Date</label>
                <input type="date" id="openDate" name="openDate" readonly>
            </div>
            
            <div class="form-group">
                <label for="newTaskDescription">Task Description</label>
                <textarea id="newTaskDescription" name="newTaskDescription" required placeholder="Describe the maintenance work to be performed in detail..."></textarea>
            </div>
            
            <div class="button-container">
                <button type="submit" class="submit-btn">Open Job Card</button>
            </div>
        </form>
    </div>

    
    </div>
  </div>

<script>
    let lastJobCardID = 3100; // Will be fetched from Google Sheets

    async function initOpenJobCard() {
        try {
            // Check server availability first
            if (!railwayAPI.isServerAvailable) {
                await railwayAPI.checkServerConnection();
            }
            
            if (railwayAPI.isServerAvailable) {
                const existingCards = await railwayAPI.getJobCardData();
                if (existingCards && existingCards.length > 0) {
                    // Find max numeric JC id to avoid ordering issues
                    const maxNum = existingCards.reduce((max, c) => {
                        const n = parseInt((c.JobCard_ID||'').toString().replace(/[^0-9]/g,''), 10);
                        return isNaN(n) ? max : Math.max(max, n);
                    }, 0);
                    lastJobCardID = maxNum;
                }
            } else {
                // Server not available, use fallback
                console.warn('Server not available, using fallback job card ID');
                railwayAPI.showMessage('Server not available. Job cards will use fallback numbering.', 'error');
            }
            
            document.getElementById('newJobCardID').value = `JC${lastJobCardID + 1}`;
            document.getElementById('openDate').value = new Date().toISOString().split('T')[0];
        } catch (error) {
            console.error('Error in initOpenJobCard:', error);
            railwayAPI.showMessage(`Error loading job card data: ${error.message}`, 'error');
            // Still set defaults even if there's an error
            document.getElementById('newJobCardID').value = `JC${lastJobCardID + 1}`;
            document.getElementById('openDate').value = new Date().toISOString().split('T')[0];
        }
    }

    // Handle opening new job card
    document.getElementById('openCardForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const jobCardData = {
            JobCard_ID: document.getElementById('newJobCardID').value,
            Train_ID: document.getElementById('newTrainID').value,
            Task_Description: document.getElementById('newTaskDescription').value,
            Opened_Date: railwayAPI.formatDateForSheets(document.getElementById('openDate').value),
            Status: 'Open',
            Closed_Date: 'NULL'
        };
        
        try {
            await railwayAPI.saveJobCardData(jobCardData);
            railwayAPI.showMessage('Job card opened successfully!');
            // Reset form and prepare next auto ID
            document.getElementById('openCardForm').reset();
            await initOpenJobCard();
            
        } catch (error) {
            railwayAPI.showMessage(`Error opening job card: ${error.message}`, 'error');
        }
    });
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initOpenJobCard);
</script>

<!-- Include the Railway API -->
<script src="railway-api.js"></script>

</body>
</html>