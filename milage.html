<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mileage Balancing</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
    <div class="page-header">
        <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê</button>
        <h1>Record Train Mileage</h1>
    </div>
    <form id="mileageForm">
        <div class="form-group">
            <label for="trainID">Train ID</label>
            <select id="trainID" name="trainID">
                <option value="" disabled selected>Select a Train ID</option>
            </select>
        </div>

        <div class="form-group">
            <label for="totalKM">Current Total Kilometers</label>
            <input type="text" id="totalKM" name="totalKM" readonly>
        </div>

        <!-- Removed Date field: updates should not include per-day rows -->

        <div class="form-group">
            <label for="kmTravelled">Kilometers Travelled</label>
            <input type="number" id="kmTravelled" name="kmTravelled" required min="0" step="0.1" placeholder="Enter kilometers for the selected date">
        </div>
        
        <div class="button-container">
            <button type="submit" class="submit-btn">Record Mileage</button>
        </div>
    </form>
</div>

<script>
    // Live data loaded from Sheets
    let mileageByTrain = {};
    let trainsLoaded = false;

    const form = document.getElementById('mileageForm');
    const trainIDSelect = document.getElementById('trainID');
    const totalKMInput = document.getElementById('totalKM');
    // No date input anymore
    const kmTravelledInput = document.getElementById('kmTravelled');

    // Populate Train IDs from Sheets
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            if (!railwayAPI.isServerAvailable) {
                await railwayAPI.checkServerConnection();
            }
            const rows = await railwayAPI.getMileageData();
            const options = new Set();
            mileageByTrain = {};
            (rows || []).forEach(r => {
                const id = (r.Train_ID || '').trim();
                if (id) {
                    options.add(id);
                    mileageByTrain[id] = r;
                }
            });
            // Populate select
            options.forEach(id => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = id;
                trainIDSelect.appendChild(opt);
            });
            trainsLoaded = true;
            form.querySelector('button[type="submit"]').disabled = true;
        } catch (e) {
            trainsLoaded = false;
            railwayAPI.showMessage('Unable to load Train IDs. Please check server connection.', 'error');
            form.querySelector('button[type="submit"]').disabled = true;
        }
    });

    function updateSubmitEnabled() {
        const validTrain = !!trainIDSelect.value;
        const km = parseFloat(kmTravelledInput.value);
        const validKm = !isNaN(km) && km > 0;
        form.querySelector('button[type="submit"]').disabled = !(trainsLoaded && validTrain && validKm);
    }

    trainIDSelect.addEventListener('change', () => {
        const selectedTrainID = trainIDSelect.value;
        const row = mileageByTrain[selectedTrainID];
        if (row && row.Total_KM !== undefined) {
            // Show as locale string; strip commas for calculations later
            const num = parseInt((row.Total_KM || '0').toString().replace(/[,\s]/g, ''), 10) || 0;
            totalKMInput.value = num.toLocaleString('en-IN');
        } else {
            totalKMInput.value = '';
        }
        updateSubmitEnabled();
    });

    kmTravelledInput.addEventListener('input', updateSubmitEnabled);

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
    const trainID = trainIDSelect.value;
        const kmTravelled = parseFloat(kmTravelledInput.value);
        const existingKM = parseInt(totalKMInput.value.replace(/,/g, ''), 10);
        const totalNewKM = existingKM + kmTravelled;
        
        // Prepare data for Google Sheets (update existing row by Train_ID)
        const payload = {
            Total_KM: totalNewKM.toString(),
            KM_Since_Last_A: totalNewKM.toString(),
            KM_Since_Last_B: totalNewKM.toString(),
            KM_Since_Last_C: totalNewKM.toString(),
            KM_Since_Last_D: totalNewKM.toString(),
            Daily_Avg_KM: kmTravelled.toString()
        };
        
        try {
            // Update existing mileage row by Train_ID
            await railwayAPI.updateMileageData(trainID, payload);
            railwayAPI.showMessage(`Mileage recorded successfully! ${kmTravelled} KM added for ${trainID}. New total: ${totalNewKM.toLocaleString()} KM.`);
            
            // Update the displayed total
            // Update local cache so UI stays in sync
            if (!mileageByTrain[trainID]) mileageByTrain[trainID] = {};
            mileageByTrain[trainID].Total_KM = totalNewKM.toString();
            totalKMInput.value = totalNewKM.toLocaleString();
            
            // Clear only the KM travelled field, keep train selection
            kmTravelledInput.value = '';
            
        } catch (error) {
            railwayAPI.showMessage(`Error updating mileage: ${error.message}`, 'error');
        }
    });
</script>

<!-- Include the Railway API -->
<script src="railway-api.js"></script>

</body>
</html>